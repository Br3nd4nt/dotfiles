#!/bin/bash

# =============================================================================
# Dotfiles Installation Script
# =============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Function to check if file/directory exists
check_exists() {
    local target="$1"
    if [ -f "$target" ] || [ -d "$target" ]; then
        print_warning "Will backup: $target -> $target.backup"
        return 0
    else
        print_success "Will create: $target"
        return 1
    fi
}

# Get the directory where this script is located
DOTFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

print_status "Dotfiles installation preview from: $DOTFILES_DIR"
print_status "This script will show what would be installed."
print_status "To actually install, run: ./install.sh --install"
print_status "To uninstall, run: ./install.sh --uninstall"
echo

# Check if --uninstall --confirm flag is provided
if [[ "$1" == "--uninstall" && "$2" == "--confirm" ]]; then
    print_status "=== UNINSTALLING DOTFILES ==="

    # Function to remove symlink and restore backup
    remove_symlink_and_restore() {
        local target="$1"
        local backup="$1.backup"

        if [ -L "$target" ]; then
            rm "$target"
            print_success "Removed symlink: $target"
        fi

        if [ -f "$backup" ] || [ -d "$backup" ]; then
            mv "$backup" "$target"
            print_success "Restored backup: $backup -> $target"
        fi
    }

    # Remove symlinks and restore backups
    print_status "Removing symlinks and restoring backups..."
    remove_symlink_and_restore "$HOME/.zshrc"
    remove_symlink_and_restore "$HOME/.zprofile"
    remove_symlink_and_restore "$HOME/.gitconfig"
    remove_symlink_and_restore "$HOME/.gitignore_global"
    remove_symlink_and_restore "$HOME/.config/nvim"
    remove_symlink_and_restore "$HOME/.config/ohmyposh"
    remove_symlink_and_restore "$HOME/.config/htop/htoprc"
    remove_symlink_and_restore "$HOME/.config/ghostty/config"

    # Remove system utilities
    print_status "Removing system utilities..."
    if [ -f "/usr/local/bin/fzf-git" ]; then
        sudo rm "/usr/local/bin/fzf-git"
        print_success "Removed: /usr/local/bin/fzf-git"
    fi

    print_success "Dotfiles uninstallation completed!"
    print_status "Please restart your terminal to apply changes."
    exit 0
fi

# Check if --uninstall flag is provided (preview mode)
if [[ "$1" == "--uninstall" ]]; then
    print_status "=== UNINSTALL MODE ==="
    print_status "The following actions would be performed:"
    echo

    # Check what would be removed
    print_status "Symlinks to remove:"
    if [ -L "$HOME/.zshrc" ]; then
        print_warning "Will remove symlink: $HOME/.zshrc"
    fi
    if [ -L "$HOME/.zprofile" ]; then
        print_warning "Will remove symlink: $HOME/.zprofile"
    fi
    if [ -L "$HOME/.gitconfig" ]; then
        print_warning "Will remove symlink: $HOME/.gitconfig"
    fi
    if [ -L "$HOME/.gitignore_global" ]; then
        print_warning "Will remove symlink: $HOME/.gitignore_global"
    fi
    if [ -L "$HOME/.config/nvim" ]; then
        print_warning "Will remove symlink: $HOME/.config/nvim"
    fi
    if [ -L "$HOME/.config/ohmyposh" ]; then
        print_warning "Will remove symlink: $HOME/.config/ohmyposh"
    fi
    if [ -L "$HOME/.config/htop/htoprc" ]; then
        print_warning "Will remove symlink: $HOME/.config/htop/htoprc"
    fi
    if [ -L "$HOME/.config/ghostty/config" ]; then
        print_warning "Will remove symlink: $HOME/.config/ghostty/config"
    fi
    echo

    print_status "Backups to restore:"
    if [ -f "$HOME/.zshrc.backup" ]; then
        print_success "Will restore: $HOME/.zshrc.backup -> $HOME/.zshrc"
    fi
    if [ -f "$HOME/.zprofile.backup" ]; then
        print_success "Will restore: $HOME/.zprofile.backup -> $HOME/.zprofile"
    fi
    if [ -f "$HOME/.gitconfig.backup" ]; then
        print_success "Will restore: $HOME/.gitconfig.backup -> $HOME/.gitconfig"
    fi
    if [ -f "$HOME/.gitignore_global.backup" ]; then
        print_success "Will restore: $HOME/.gitignore_global.backup -> $HOME/.gitignore_global"
    fi
    if [ -d "$HOME/.config/nvim.backup" ]; then
        print_success "Will restore: $HOME/.config/nvim.backup -> $HOME/.config/nvim"
    fi
    if [ -d "$HOME/.config/ohmyposh.backup" ]; then
        print_success "Will restore: $HOME/.config/ohmyposh.backup -> $HOME/.config/ohmyposh"
    fi
    if [ -f "$HOME/.config/htop/htoprc.backup" ]; then
        print_success "Will restore: $HOME/.config/htop/htoprc.backup -> $HOME/.config/htop/htoprc"
    fi
    if [ -f "$HOME/.config/ghostty/config.backup" ]; then
        print_success "Will restore: $HOME/.config/ghostty/config.backup -> $HOME/.config/ghostty/config"
    fi
    echo

    print_status "System utilities:"
    if [ -f "/usr/local/bin/fzf-git" ]; then
        print_warning "Will remove: /usr/local/bin/fzf-git"
    fi
    echo

    print_status "To uninstall, run: ./install.sh --uninstall --confirm"
    exit 0
fi

# Check if --install flag is provided
if [[ "$1" != "--install" ]]; then
    print_status "=== PREVIEW MODE ==="
    print_status "The following symlinks would be created:"
    echo

    # Main dotfiles
    print_status "Main dotfiles:"
    check_exists "$HOME/.zshrc"
    check_exists "$HOME/.zprofile"
    check_exists "$HOME/.gitconfig"
    check_exists "$HOME/.gitignore_global"
    check_exists "$HOME/.config/htop/htoprc"
    check_exists "$HOME/.config/ghostty/config"
    echo

    # Config directories
    print_status "Configuration directories:"
    check_exists "$HOME/.config/nvim"
    check_exists "$HOME/.config/ohmyposh"
    echo
    print_status "Note: Neovim uses Lazy.nvim for plugin management (no git submodules)"
    echo

    # System utilities
    print_status "System utilities:"
    if [ -f "/usr/local/bin/fzf-git" ]; then
        print_warning "Already installed: /usr/local/bin/fzf-git"
    else
        print_success "Will install: /usr/local/bin/fzf-git"
    fi
    echo

    print_status "To install, run: ./install.sh --install"
    exit 0
fi

print_status "=== INSTALLATION MODE ==="

# Function to create symlink
create_symlink() {
    local source="$1"
    local target="$2"

    if [ -L "$target" ]; then
        print_warning "Symlink already exists: $target"
        return 0
    fi

    if [ -f "$target" ] || [ -d "$target" ]; then
        print_warning "Backing up existing file/directory: $target"
        mv "$target" "$target.backup"
    fi

    ln -sf "$source" "$target"
    print_success "Created symlink: $target -> $source"
}

# Create necessary directories
print_status "Creating necessary directories..."
mkdir -p ~/.config
mkdir -p ~/.config/htop
mkdir -p ~/.config/ghostty
mkdir -p ~/.local/bin

# Install main dotfiles
print_status "Installing main dotfiles..."

# ZSH configuration
create_symlink "$DOTFILES_DIR/zshrc" "$HOME/.zshrc"
create_symlink "$DOTFILES_DIR/zprofile" "$HOME/.zprofile"

# Git configuration
create_symlink "$DOTFILES_DIR/gitconfig" "$HOME/.gitconfig"
create_symlink "$DOTFILES_DIR/gitignore_global" "$HOME/.gitignore_global"

# Htop configuration
create_symlink "$DOTFILES_DIR/config/htop/htoprc" "$HOME/.config/htop/htoprc"

# Ghostty configuration
create_symlink "$DOTFILES_DIR/config/ghostty/config" "$HOME/.config/ghostty/config"

# Install config directories
print_status "Installing configuration directories..."

# Neovim
if [ -d "$DOTFILES_DIR/config/nvim" ]; then
    create_symlink "$DOTFILES_DIR/config/nvim" "$HOME/.config/nvim"
    print_status "Neovim configuration linked (using Lazy.nvim for plugins)"
    print_status "Plugins will be automatically installed on first Neovim startup"
fi

# Oh My Posh
if [ -d "$DOTFILES_DIR/config/ohmyposh" ]; then
    create_symlink "$DOTFILES_DIR/config/ohmyposh" "$HOME/.config/ohmyposh"
fi

# FZF Git - Install as system utility
print_status "Installing fzf-git.sh as system utility..."
if [ -f "/usr/local/bin/fzf-git" ]; then
    print_warning "fzf-git already installed at /usr/local/bin/fzf-git"
    print_status "Skipping installation..."
else
    print_warning "fzf-git not found, downloading from GitHub..."
    curl -s https://raw.githubusercontent.com/junegunn/fzf-git.sh/main/fzf-git.sh | sudo tee /usr/local/bin/fzf-git > /dev/null
    sudo chmod +x /usr/local/bin/fzf-git
    print_success "Downloaded and installed fzf-git.sh to /usr/local/bin/fzf-git"
fi

print_success "Dotfiles installation completed!"
print_status "Please restart your terminal or run 'source ~/.zshrc' to apply changes."
