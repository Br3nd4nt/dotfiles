# ==================
# ZSH Configuration
# ==================

# =======================
# Homebrew Configuration
# =======================
{{- if eq .chezmoi.os "darwin" }}
export HOMEBREW_AUTO_UPDATE_SECS=604800
export PATH="/opt/homebrew/bin:$PATH"
{{- end }}

# =======================
# Oh My Zsh Configuration
# =======================
export ZSH="$HOME/.oh-my-zsh"
ENABLE_CORRECTION="true"
COMPLETION_WAITING_DOTS="true"
plugins=(git fzf-docker)

# ==============
# Load Oh My Zsh
# ==============
source $ZSH/oh-my-zsh.sh

# ==================
# Shell Enhancements
# ==================
# Oh My Posh prompt (only if installed)
if command -v oh-my-posh &> /dev/null; then
  eval "$(oh-my-posh init zsh --config $HOME/.config/ohmyposh/base.toml)"
fi

# Zoxide (smart cd)
if command -v zoxide &> /dev/null; then
  eval "$(zoxide init zsh)"
fi

# FZF Git integration
{{- if eq .chezmoi.os "darwin" }}
if [ -f /usr/local/bin/fzf-git ]; then
  source /usr/local/bin/fzf-git
fi
{{- else if eq .chezmoi.os "linux" }}
if [ -f ~/.local/bin/fzf-git ]; then
  source ~/.local/bin/fzf-git
fi
{{- end }}

# =================
# FZF Configuration
# =================
if command -v fzf &> /dev/null; then
  eval "$(fzf --zsh)"
fi

export FZF_DEFAULT_COMMAND="fd --hidden --strip-cwd-prefix --exclude .git"
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
export FZF_ALT_C_COMMAND="$FZF_DEFAULT_COMMAND --type=d"

_fzf_compgen_path() {
  fd --hidden --exclude .git . "$1"
}

_fzf_compgen_dir() {
  fd --hidden --exclude .git --type=d . "$1"
}

# ==============
# Editor Aliases
# ==============
if [[ -z $SSH_CONNECTION ]]; then
  alias vim=nvim
  alias v=nvim
fi

# ============
# User Aliases
# ============

# Basic aliases
alias l='ls'
alias ll='ls -lha'
alias suod='sudo'
alias grep='rg'
alias myip='curl ipv4.icanhazip.com'
alias fman="compgen -c | fzf | xargs tldr"

# Color support
grep --color=auto < /dev/null &>/dev/null && alias grep='grep --color=auto'
{{- if eq .chezmoi.os "linux" }}
xdg-open --version &>/dev/null && alias open='xdg-open'
{{- end }}

# Enable color support of ls
if ls --color=auto &>/dev/null; then
	alias ls='ls -p --color=auto'
else
	alias ls='ls -p -G'
fi

# File management
{{- if eq .chezmoi.os "darwin" }}
alias cleands='find . -name ".DS_Store" -type f -delete'
{{- end }}
alias cd=z
alias find=fd

# Development tools
alias gl="git log --graph --pretty=oneline --abbrev-commit"
{{- if eq .chezmoi.os "darwin" }}
alias slf="swiftlint --fix"
{{- end }}

# System utilities
{{- if eq .chezmoi.os "darwin" }}
alias bubu="brew update && brew upgrade"
{{- else if eq .chezmoi.os "linux" }}
alias bubu="sudo apt update && sudo apt upgrade"
{{- end }}

# Configuration editing
alias zcf="vim ~/.zshrc"
alias zs="source ~/.zshrc"

# Git aliases
alias ga='git add . --all'
alias gb='git branch'
alias gcl='git clone'
alias gc='git commit -am'
alias gco='git checkout'
alias gd="git diff ':!*lock'"
alias gi='git init'
alias gl='git log'
alias gp='git push origin HEAD'
alias gs='git status'
alias gu='git pull' # gu = git update

# ============
# Key Bindings
# ============
function clear-scrollback-buffer {
  clear && printf '\e[3J'
  zle && zle .reset-prompt && zle -R
}

zle -N clear-scrollback-buffer
bindkey '^L' clear-scrollback-buffer

# ==================
# Machine-specific configurations
# ==================
# Machine: {{ .chezmoi.hostname }}
# User: {{ .chezmoi.username }}
# OS: {{ .chezmoi.os }}
